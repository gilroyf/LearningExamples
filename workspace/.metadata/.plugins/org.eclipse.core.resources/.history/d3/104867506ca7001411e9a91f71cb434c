/**
 * 
 */

function Video(localVideoDiv) {
	this.localVDiv = localVideoDiv;
	this.localMediaStream = null;
	var peerConnection = this.__getPeerConnection();
	this.pcr = new peerConnection();
}

Video.prototype.__getUserMediaSuccessfulCB = function(ms) {
	var video = $('.localVideo')[0];//this.localVDiv;
	video.src = window.URL.createObjectURL(ms);
	this.localMediaStream =  ms;
	
	//send offer to server
	this.pcr.addStream(ms);
	var obj = this;
	this.pcr.createOffer(function(desc) {obj.__gotDescription(desc);}, function(e) {log.console(e);});
	
}

Video.prototype.__gotDescription = function(desc) {
	this.pcr.setLocalDescription(desc);
	// send desciption to server
	/*
	var jqxhr = $.post("http://localhost:8080/intercom/rest/intercomserver", 
			JSON.stringify( {"sdp":"help"} ), 
			function(a,b,c) { console.log("SUCCESS"+ s);}, 
			'application/json')
	.done(function () {console.log("done");})
	.fail(function() {console.log("fail");})
	.always(function() {console.log("always");});
	*/
	$.ajax({
		  url:"rest/intercomserver",
		  type:"POST",
		  data:JSON.stringify( {"sdp":desc}),
		  contentType:"application/json",
		  dataType:"json",
		  success: function(){
			  console.log("done");
		  }, 
		  error: function(a,b,c) {
			  console.log("error"+b+" "+c );
		  }
		});
	
}

Video.prototype.__getUserMediaErrorCB = function() {
	
	
}

Video.prototype.__getPeerConnection = function() {
	return window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
}

Video.prototype.__hasUserMedia = function() {
	return !!this.__getMedia();//(navigator.getUserMedia || navigator.webkitGetUserMedia ||navigator.mozGetUserMedia || navigator.msGetUserMedia);
}

Video.prototype.__getMedia = function () {
	return 	navigator.getUserMedia || navigator.webkitGetUserMedia || 
			navigator.mozGetUserMedia || navigator.msGetUserMedia;	
}

Video.prototype.init= function() {
	if (!this.__hasUserMedia()) {
		console.log("No usermedia Returning");
	}
	var obj = this;
	navigator.getUserMedia = this.__getMedia();//navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;// _getMedia();
	navigator.getUserMedia({video:true, audio:true}, function(ms){obj.__getUserMediaSuccessfulCB(ms);}, function(){obj.__getUserMediaErrorCB();});

}

Video.prototype.getSourceVideo = function() {
	var peerSourceConnection = this.__getPeerConnection();
	this.pcr = new peerSourceConnection();
	var pcrObj = this.pcr;
	this.pcr.onaddstream = function (evt) {
	        remoteView.src = URL.createObjectURL(evt.stream);
	    };
	$.ajax({
		  url:"rest/intercomserver",
		  type:"GET",
//		  data:JSON.stringify( {"sdp":desc}),
//		  contentType:"application/json",
		  dataType:"json",
		  success: function(data){
			  console.log("done data = ", data);
			  var desc = window.RTCSessionDescription || window.mozRTCSessionDescription || window.webkitRTCSessionDescription;
			  var x = new desc(JSON.parse(data));
			  pcrObj.setRemoteDescription(x, function() {
				  pcrObj.createAnswer(
					  function(answer) {
						  //pcr.remoteDescription,
						  procObj.setLocalDescription(answer);
					  }  ,
					  function(err) {
						  console.log(err);
					  }
			  );})
		  }, 
		  error: function(a,b,c) {
			  console.log("error"+b+" "+c );
		  }
		});
	
}